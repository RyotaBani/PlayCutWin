name: build-windows

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    env:
      CONFIGURATION: Release
      RUNTIME: win-x64
      ARTIFACT_NAME: PlayCutWin-win-x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # ✅ ここが肝：sln があればそれを、無ければ WPF csproj を自動で拾う
      - name: Detect solution/project
        shell: pwsh
        run: |
          $sln = Get-ChildItem -Recurse -Filter *.sln | Select-Object -First 1
          if ($sln) {
            "BUILD_TARGET=$($sln.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append
            "TARGET_KIND=sln" | Out-File -FilePath $env:GITHUB_ENV -Append
            Write-Host "Using solution: $($sln.FullName)"
            exit 0
          }

          $csproj = Get-ChildItem -Recurse -Filter *.csproj | Where-Object {
            # WPFっぽいプロジェクト優先（UseWPF を含むやつ）
            (Get-Content $_.FullName -Raw) -match "<UseWPF>\s*true\s*</UseWPF>"
          } | Select-Object -First 1

          if (-not $csproj) {
            # 最悪 fallback：最初のcsproj
            $csproj = Get-ChildItem -Recurse -Filter *.csproj | Select-Object -First 1
          }

          if (-not $csproj) {
            Write-Error "No .sln or .csproj found."
            exit 1
          }

          "BUILD_TARGET=$($csproj.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append
          "TARGET_KIND=csproj" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Using project: $($csproj.FullName)"

      - name: Restore
        run: dotnet restore "${{ env.BUILD_TARGET }}"

      - name: Build
        run: dotnet build "${{ env.BUILD_TARGET }}" -c ${{ env.CONFIGURATION }} --no-restore

      # ✅ publish は「csproj」を渡すのが確実（slnだと複数プロジェクトで崩れやすい）
      - name: Detect app csproj for publish
        shell: pwsh
        run: |
          $csproj = Get-ChildItem -Recurse -Filter *.csproj | Where-Object {
            (Get-Content $_.FullName -Raw) -match "<UseWPF>\s*true\s*</UseWPF>"
          } | Select-Object -First 1

          if (-not $csproj) {
            $csproj = Get-ChildItem -Recurse -Filter *.csproj | Select-Object -First 1
          }

          "PUBLISH_PROJECT=$($csproj.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Publish project: $($csproj.FullName)"

      - name: Publish (self-contained)
        run: >
          dotnet publish "${{ env.PUBLISH_PROJECT }}"
          -c ${{ env.CONFIGURATION }}
          -r ${{ env.RUNTIME }}
          --self-contained true
          -p:PublishSingleFile=false
          -p:PublishTrimmed=false
          -o "${{ github.workspace }}\publish"

      - name: Zip publish folder
        shell: pwsh
        run: |
          $zipPath = "${{ github.workspace }}\${{ env.ARTIFACT_NAME }}.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path "${{ github.workspace }}\publish\*" -DestinationPath $zipPath
          Write-Host "Zipped -> $zipPath"
          Get-Item $zipPath | Format-List Name,Length,FullName

      - name: Upload Artifact (ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_NAME }}.zip
          if-no-files-found: error
