using Microsoft.Win32;
using System.ComponentModel;
using System.IO;
using System.Windows;
using System.Windows.Controls;
using PlayCutWin.Views;

namespace PlayCutWin
{
    public partial class MainWindow : Window
    {
        public MainWindow()
        {
            InitializeComponent();

            // AppState の変更を StatusBar に反映
            AppState.Instance.PropertyChanged += AppState_PropertyChanged;
            UpdateStatusBar();

            // 初期表示
            MenuList.SelectedIndex = 0; // Dashboard
        }

        private void AppState_PropertyChanged(object? sender, PropertyChangedEventArgs e)
        {
            if (e.PropertyName == nameof(AppState.SelectedVideoPath) ||
                e.PropertyName == nameof(AppState.SelectedVideoFileName))
            {
                Dispatcher.Invoke(UpdateStatusBar);
            }
        }

        private void UpdateStatusBar()
        {
            var selected = AppState.Instance.SelectedVideoFileName;
            StatusText.Text = $"Ready - {PageTitle.Text} | Selected: {selected}";
        }

        private void MenuList_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (MenuList.SelectedItem is not ListBoxItem item) return;
            var key = item.Content?.ToString() ?? "Dashboard";
            NavigateTo(key);
        }

        private void NavigateTo(string key)
        {
            PageTitle.Text = key;

            switch (key)
            {
                case "Dashboard":
                    MainContent.Content = new DashboardView();
                    break;
                case "Clips":
                    MainContent.Content = new ClipsView();
                    break;
                case "Tags":
                    MainContent.Content = new TagsView();
                    break;
                case "Exports":
                    MainContent.Content = new ExportsView();
                    break;
                default:
                    MainContent.Content = new DashboardView();
                    break;
            }

            UpdateStatusBar();
        }

        private void ImportVideo_Click(object sender, RoutedEventArgs e)
        {
            var dlg = new OpenFileDialog
            {
                Title = "Import Video",
                Filter = "Video Files|*.mp4;*.mov;*.m4v;*.avi;*.mkv|All Files|*.*",
                Multiselect = true
            };

            if (dlg.ShowDialog() != true)
            {
                StatusText.Text = "Import cancelled";
                return;
            }

            foreach (var file in dlg.FileNames)
            {
                if (File.Exists(file))
                    AppState.Instance.ImportedVideos.Add(file);
            }

            // 先頭を「選択中」にする（複数選択でもOK）
            if (dlg.FileNames.Length > 0)
                AppState.Instance.SelectedVideoPath = dlg.FileNames[0];

            MessageBox.Show($"Selected:\n{dlg.FileNames[0]}", "Import", MessageBoxButton.OK, MessageBoxImage.Information);

            // Importしたら自動で Clips に移動
            MenuList.SelectedIndex = 1; // Clips
        }

        private void ExportClip_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("Export (placeholder)\nここにクリップ書き出しを追加する。", "PlayCut",
                MessageBoxButton.OK, MessageBoxImage.Information);
        }

        private void Settings_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("Settings (placeholder)\n次にここに設定画面を追加する。", "PlayCut",
                MessageBoxButton.OK, MessageBoxImage.Information);
        }
    }
}
